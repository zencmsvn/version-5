!function () {
    tinymce.create("tinymce.plugins.BBCodePlugin", {init: function (e) {
        var t = this, n = e.getParam("bbcode_dialect", "punbb").toLowerCase();
        e.on("beforeSetContent", function (e) {
            e.content = t["_" + n + "_bbcode2html"](e.content)
        }), e.on("postProcess", function (e) {
            e.set && (e.content = t["_" + n + "_bbcode2html"](e.content)), e.get && (e.content = t["_" + n + "_html2bbcode"](e.content))
        })
    }, getInfo: function () {
        return{longname: "BBCode Plugin", author: "Moxiecode Systems AB", authorurl: "http://www.tinymce.com", infourl: "http://www.tinymce.com/wiki.php/Plugin:bbcode"}
    }, _punbb_html2bbcode: function (e) {
        function t(t, n, removebr) {
            e = e.replace(t, n);

        }
        return e = tinymce.trim(e),
            t(/<textarea((.|[\r\n])*?)>((.|[\r\n])*?)<\/textarea>/gi, '[textarea]$3[/textarea]'),

            t(/<span style=\"((.|[\r\n])*?)text-decoration:(\s*?)underline((.|[\r\n])*?)\">((.|[\r\n])*?)<\/span>/gi, "[u]$6[/u]"),
            t(/<u((.|[\r\n])*?)>((.|[\r\n])*?)<\/u>/gi, "[u]$3[/u]"),
            t(/<b((.|[\r\n])*?)>((.|[\r\n])*?)<\/b>/gi, "[b]$3[/b]"),
            t(/<strong((.|[\r\n])*?)>((.|[\r\n])*?)<\/strong>/gi, "[b]$3[/b]"),
            t(/<i((.|[\r\n])*?)>((.|[\r\n])*?)<\/i>/gi, "[i]$3[/i]"),
            t(/<em((.|[\r\n])*?)>((.|[\r\n])*?)<\/em>/gi, "[i]$3[/i]"),
            t(/<blockquote((.|[\r\n])*?)>((.|[\r\n])*?)<\/blockquote>/gi, "[quote]$3[/quote]"),

            t(/<a((.|[\r\n])*?)href=\"(.*?)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/a>/gi, "[url=$3]$6[/url]"),
            t(/<img((.|[\r\n])*?)src(\s*?)=(\s*?)\"(.*?)\"((.|[\r\n])*?)>/gi, "[img]$5[/img]"),

            t(/<p((.|[\r\n])*?)class(\s*?)=(\s*?)\"(codeStyle|code)\">((.|[\r\n])*?)<\/p>/gi, "[code]$6[/code]"),
            t(/<div((.|[\r\n])*?)class(\s*?)=(\s*?)\"(codeStyle|code)\">((.|[\r\n])*?)<\/div>/gi, "[code]$6[/code]"),

            t(/<code((.|[\r\n])*?)>((.|[\r\n])*?)<\/code>/gi, "[code]$3[/code]"),
            t(/<pre((.|[\r\n])*?)>((.|[\r\n])*?)<\/pre>/gi, "[code]$3[/code]"),
            t(/<span((.|[\r\n])*?)class(\s*?)=(\s*?)\"(codeStyle|code)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/span>/gi, "[code]$8[/code]"),
            t(/<strong((.|[\r\n])*?)class(\s*?)=(\s*?)\"(codeStyle|code)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/strong>/gi, "[code]$8[/code]"),
            t(/<em((.|[\r\n])*?)class(\s*?)=(\s*?)\"(codeStyle|code)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/em>/gi, "[code]$8[/code]"),
            t(/<i((.|[\r\n])*?)class(\s*?)=(\s*?)\"(codeStyle|code)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/i>/gi, "[code]$8[/code]"),
            t(/<u((.|[\r\n])*?)class(\s*?)=(\s*?)\"(codeStyle|code)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/u>/gi, "[code]$8[/code]"),
            t(/<b((.|[\r\n])*?)class(\s*?)=(\s*?)\"(codeStyle|code)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/b>/gi, "[code]$8[/code]"),

            t(/<span((.|[\r\n])*?)class(\s*?)=(\s*?)\"(quoteStyle|quote)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/span>/gi, "[quote]$8[/quote]"),
            t(/<strong((.|[\r\n])*?)class(\s*?)=(\s*?)\"(quoteStyle|quote)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/strong>/gi, "[quote]$8[/quote]"),
            t(/<em((.|[\r\n])*?)class(\s*?)=(\s*?)\"(quoteStyle|quote)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/em>/gi, "[quote]$8[/quote]"),
            t(/<i((.|[\r\n])*?)class(\s*?)=(\s*?)\"(quoteStyle|quote)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/i>/gi, "[quote]$8[/quote]"),
            t(/<u((.|[\r\n])*?)class(\s*?)=(\s*?)\"(quoteStyle|quote)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/u>/gi, "[quote]$8[/quote]"),
            t(/<b((.|[\r\n])*?)class(\s*?)=(\s*?)\"(quoteStyle|quote)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/b>/gi, "[quote]$8[/quote]"),

            t(/<p((.|[\r\n])*?)class(\s*?)=(\s*?)\"(quoteStyle|quote)\">((.|[\r\n])*?)<\/p>/gi, "[quote]$6[/quote]"),
            t(/<div((.|[\r\n])*?)class(\s*?)=(\s*?)\"(quoteStyle|quote)\">((.|[\r\n])*?)<\/div>/gi, "[quote]$6[/quote]"),

            t(/<p((.|[\r\n])*?)text-align(\s*?):(\s*?)center((.|[\r\n])*?)>((.|[\r\n])*?)<\/p>/gi, '[center]$7[/center]'),
            t(/<div((.|[\r\n])*?)text-align(\s*?):(\s*?)center((.|[\r\n])*?)>((.|[\r\n])*?)<\/div>/gi, '[center]$7[/center]'),

            t(/<p((.|[\r\n])*?)text-align(\s*?):(\s*?)left((.|[\r\n])*?)>((.|[\r\n])*?)<\/p>/gi, '[left]$7[/left]'),
            t(/<div((.|[\r\n])*?)text-align(\s*?):(\s*?)left((.|[\r\n])*?)>((.|[\r\n])*?)<\/div>/gi, '[left]$7[/left]'),

            t(/<p((.|[\r\n])*?)text-align(\s*?):(\s*?)right((.|[\r\n])*?)>((.|[\r\n])*?)<\/p>/gi, '[right]$7[/right]'),
            t(/<div((.|[\r\n])*?)text-align(\s*?):(\s*?)right((.|[\r\n])*?)>((.|[\r\n])*?)<\/div>/gi, '[right]$7[/right]'),

            t(/<font((.|[\r\n])*?)([^\-a-z0-9A-Z]+)color(\s*?):(\s*?)([a-zA-Z0-9#\-]+);?((.|[\r\n])*?)>((.|[\r\n])*?)<\/font>/gi, '[color=$6]$9[/color]'),
            t(/<font((.|[\r\n])*?)color(\s*?)=(\s*?)\"(\s*?)([a-zA-Z0-9#\-]+)(\s*?)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/font>/gi, '[color=$6]$10[/color]'),
            t(/<span((.|[\r\n])*?)([^\-a-z0-9A-Z]+)color(\s*?):(\s*?)([a-zA-Z0-9#\-]+);?((.|[\r\n])*?)>((.|[\r\n])*?)<\/span>/gi, '[color=$6]$9[/color]'),

            t(/<span((.|[\r\n])*?)([^\-a-z0-9A-Z]+)font-size(\s*?):(\s*?)([a-zA-Z0-9#\-]+);?((.|[\r\n])*?)>((.|[\r\n])*?)<\/span>/gi, '[size=$6]$9[/size]'),
            t(/<font((.|[\r\n])*?)([^\-a-z0-9A-Z]+)font-size(\s*?):(\s*?)([a-zA-Z0-9#\-]+);?((.|[\r\n])*?)>((.|[\r\n])*?)<\/font>/gi, '[size=$6]$9[/size]'),
            t(/<font((.|[\r\n])*?)size(\s*?)=(\s*?)\"(\s*?)([a-zA-Z0-9#\-]+)(\s*?)\"((.|[\r\n])*?)>((.|[\r\n])*?)<\/font>/gi, '[size=$6]$10[/size]'),

            t(/<h1((.|[\r\n])*?)>((.|[\r\n])*?)<\/h1>/gi, "[h1]$3[/h1]"),
            t(/<h2((.|[\r\n])*?)>((.|[\r\n])*?)<\/h2>/gi, "[h2]$3[/h2]"),
            t(/<h3((.|[\r\n])*?)>((.|[\r\n])*?)<\/h3>/gi, "[h3]$3[/h3]"),
            t(/<h4((.|[\r\n])*?)>((.|[\r\n])*?)<\/h4>/gi, "[h4]$3[/h4]"),
            t(/<h5((.|[\r\n])*?)>((.|[\r\n])*?)<\/h5>/gi, "[h5]$3[/h5]"),
            t(/<h6((.|[\r\n])*?)>((.|[\r\n])*?)<\/h6>/gi, "[h6]$3[/h6]"),

            t(/<ul(.*?)>((.|[\r\n])*?)<\/ul>/gi, '[ul]$2[/ul]'),
            t(/<ol(.*?)>((.|[\r\n])*?)<\/ol>/gi, '[ol]$2[/ol]'),
            t(/<li(.*?)>((.|[\r\n])*?)<\/li>/gi, '[li]$2[/li]'),

            t(/<(object|iframe)((.|[\r\n])*?)(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([a-zA-Z0-9_\-\+\.]*)((.|[\r\n])*?)<\/(object|iframe)>/gi, '[youtube]$5[/youtube]'),

            t(/<font(\s*?)>(.*?)<\/font>/gi, "$2"),
            t(/<span(\s*?)>(.*?)<\/span>/gi, "$2"),

            t(/<br((.|[\r\n])*?)\/?>/gi, "\n"),
            t(/<br>/gi, "\n"),

            t(/\[textarea\]((.|[\r\n])*?)\[\/textarea\]/gi, '[textarea]$1[/textarea]', true),

            t(/<p((.|[\r\n])*?)>/gi, ''),
            t(/<\/p>/gi, "\n"),
            t(/<div((.|[\r\n])*?)>/gi, ''),
            t(/<\/div>/gi, "\n"),
            t(/<((.|[\r\n])*?)>/gi, ''),

            t(/&nbsp;|\u00a0/gi, " "),
            t(/&quot;/gi, '"'),
            t(/&lt;/gi, "<"),
            t(/&gt;/gi, ">"),
            t(/&amp;/gi, "&"), e
    }, _punbb_bbcode2html: function (e) {
        var removebr = false;
        function t(t, n, removebr) {
            e = e.replace(t, n);
            if ( typeof(removebr) != "undefined" && removebr !== null && removebr == true) {
                var div = document.createElement("div");
                div.innerHTML = e;
                var textarea = div.getElementsByTagName("textarea");
                for(var i = 0; i < textarea.length; i++) {
                    textarea[i].innerHTML = textarea[i].innerHTML.replace(/&lt;br\s*\/?&gt;/gi, "\n");
                }
                e = div.innerHTML;
            }
        }

        return e = tinymce.trim(e),
            t(/[\r\n]/gi, "<br />"),

            t(/\[b\]/gi, "<strong>"),
            t(/\[\/b\]/gi, "</strong>"),
            t(/\[i\]/gi, "<em>"),
            t(/\[\/i\]/gi, "</em>"),
            t(/\[u\]/gi, "<u>"),
            t(/\[\/u\]/gi, "</u>"),

            t(/\[url=([^\]]+)\]((.|[\r\n])*?)\[\/url\]/gi, '<a href="$1">$2</a>'),
            t(/\[url\]((.|[\r\n])*?)\[\/url\]/gi, '<a href="$1">$1</a>'),
            t(/\[img\]((.|[\r\n])*?)\[\/img\]/gi, '<img src="$1" />'),

            t(/\[color=(.*?)\]((.|[\r\n])*?)\[\/color\]/gi, '<span style="color: $1">$2</span>'),

            t(/\[quote.*?\]((.|[\r\n])*?)\[\/quote\]/gi, '<span class="quoteStyle">$1</span>', false),

            t(/\[code\]((.|[\r\n])*?)\[\/code\]/gi, '<span class="codeStyle">$1</span>', false),

            t(/\[size=(.*?)\]((.|[\r\n])*?)\[\/size\]/gi, '<span style="font-size: $1">$2<\/span>'),

            t(/\[ul\]((.|[\r\n])*?)\[\/ul\]/gi, '<ul>$1/ul>'),
            t(/\[ol\]((.|[\r\n])*?)\[\/ol\]/gi, '<ol>$1/ol>'),
            t(/\[li\]((.|[\r\n])*?)\[\/li\]/gi, '<li>$1</li>'),

            t(/\[center\]((.|[\r\n])*?)\[\/center\]/gi, '<p style="text-align: center;">$1</p>'),
            t(/\[left\]((.|[\r\n])*?)\[\/left\]/gi, '<p style="text-align: left;">$1</p>'),
            t(/\[right\]((.|[\r\n])*?)\[\/right\]/gi, '<p style="text-align: right;">$1</p>'),

            t(/\[h1\]((.|[\r\n])*?)\[\/h1\]/gi, '<h1>$1</h1>'),
            t(/\[h2\]((.|[\r\n])*?)\[\/h2\]/gi, '<h2>$1</h2>'),
            t(/\[h3\]((.|[\r\n])*?)\[\/h3\]/gi, '<h3>$1</h3>'),
            t(/\[h4\]((.|[\r\n])*?)\[\/h4\]/gi, '<h4>$1</h4>'),
            t(/\[h5\]((.|[\r\n])*?)\[\/h5\]/gi, '<h5>$1</h5>'),
            t(/\[h6\]((.|[\r\n])*?)\[\/h6\]/gi, '<h6>$1</h6>'),

            t(/\[textarea\]((.|[\r\n])*?)\[\/textarea\]/gi, '<textarea class="textarea_box">$1</textarea>', true),

            t(/\[youtube\]((.|[\r\n])*?)\[\/youtube\]/gi, '<iframe width="500" height="281" src="//www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>'), e
    }}), tinymce.PluginManager.add("bbcode", tinymce.plugins.BBCodePlugin)
}();